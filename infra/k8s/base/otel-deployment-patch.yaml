# =============================================================================
# OpenTelemetry Agent Deployment Patch
# =============================================================================
# This patch file is used to enable the OTEL Java agent in the deployment.
# Apply this patch when you have an OTEL collector set up and want to enable
# distributed tracing.
#
# NOTE: This is a strategic merge patch - it intentionally omits required fields
# like 'selector' because they are inherited from the base deployment.
#
# Usage with Kustomize:
# Add to your overlay's kustomization.yaml:
#   patchesStrategicMerge:
#     - otel-deployment-patch.yaml
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rewine-backend
spec:
  template:
    spec:
      # Init container to download OTEL agent (alternative: use pre-built image with agent)
      initContainers:
        - name: otel-agent-init
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              wget -O /opt/opentelemetry/opentelemetry-javaagent.jar \
                https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v2.1.0/opentelemetry-javaagent.jar
          volumeMounts:
            - name: otel-agent
              mountPath: /opt/opentelemetry

      containers:
        - name: backend
          env:
            # Enable OTEL Java agent
            - name: JAVA_TOOL_OPTIONS
              value: "-javaagent:/opt/opentelemetry/opentelemetry-javaagent.jar"

            # OTEL exporter endpoint (configure for your collector)
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: rewine-backend-config
                  key: OTEL_EXPORTER_OTLP_ENDPOINT
                  optional: true

            # OTEL service name
            - name: OTEL_SERVICE_NAME
              valueFrom:
                configMapKeyRef:
                  name: rewine-backend-config
                  key: OTEL_SERVICE_NAME
                  optional: true

            # OTEL resource attributes
            - name: OTEL_RESOURCE_ATTRIBUTES
              valueFrom:
                configMapKeyRef:
                  name: rewine-backend-config
                  key: OTEL_RESOURCE_ATTRIBUTES
                  optional: true

            # OTEL traces sampler
            - name: OTEL_TRACES_SAMPLER
              valueFrom:
                configMapKeyRef:
                  name: rewine-backend-config
                  key: OTEL_TRACES_SAMPLER
                  optional: true

            - name: OTEL_TRACES_SAMPLER_ARG
              valueFrom:
                configMapKeyRef:
                  name: rewine-backend-config
                  key: OTEL_TRACES_SAMPLER_ARG
                  optional: true

          volumeMounts:
            - name: otel-agent
              mountPath: /opt/opentelemetry
              readOnly: true

      volumes:
        - name: otel-agent
          emptyDir: {}

